<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2015 杭州端点网络科技有限公司
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="ItemAutoOnShelf">
    <resultMap id="ItemAutoOnShelfMap" type="io.terminus.parana.item.model.ItemAutoOnShelf">
        <id column="id" property="id"/>
        <result column="item_id" property="itemId"/>
        <result column="left" property="left"/>
        <result column="right" property="right"/>
        <result column="current" property="current"/>
    </resultMap>

    <sql id="tb">
        parana_item_auto_on_shelfs
    </sql>

    <sql id="cols_all">
        id,
        <include refid="cols_exclude_id"/>
    </sql>

    <sql id="cols_exclude_id">
        item_id, `left`, `right`, `current`
    </sql>

    <sql id="vals">
        #{itemId}, #{left}, #{right}, #{current}
    </sql>

    <insert id="setting" parameterType="list">
        INSERT INTO
        <include refid="tb"/>
        (<include refid="cols_exclude_id"/>)
        VALUES
        <foreach collection="list" item="i" index="index" separator=",">
            (#{i.itemId}, #{i.left}, #{i.right}, #{i.current})
        </foreach>
    </insert>

    <select id="load" parameterType="long" resultMap="ItemAutoOnShelfMap">
        SELECT
        <include refid="cols_all"/>
        FROM
        <include refid="tb"/>
        WHERE id = #{id} LIMIT 1
    </select>

    <update id="closeByItemIds" parameterType="list">
        UPDATE
        <include refid="tb"/>
        SET `current` = 3 WHERE `current` = 2 AND
        item_id IN
        <foreach collection="list" item="i" open="(" separator="," close=")">
            #{i}
        </foreach>
    </update>

    <update id="closeByRange" parameterType="map">
        UPDATE
        <include refid="tb"/>
        SET `current` = 3 WHERE `current` = 2 AND
        <![CDATA[
          `right` >= #{left} AND `right` <= #{right}
        ]]>
    </update>

    <update id="openByRange" parameterType="map">
        UPDATE
        <include refid="tb"/>
        SET `current` = 2 WHERE `current` = 2 AND
        <![CDATA[
          `left` >= #{left} AND `left` <= #{right}
        ]]>
    </update>

    <select id="checkDup" parameterType="map">
        SELECT count(1) FROM
        <include refid="tb"/>
        WHERE `right` >= #{left} AND
        item_id IN
        <foreach collection="itemIds" item="i" open="(" separator="," close=")">
            #{i}
        </foreach>
    </select>

    <select id="getIfPresent" parameterType="long" resultMap="ItemAutoOnShelfMap">
        SELECT <include refid="cols_all"/>
        FROM <include refid="tb"/>
        WHERE item_id = #{itemId} AND
        <![CDATA[
          `right` >= now()
        ]]>
    </select>
</mapper>